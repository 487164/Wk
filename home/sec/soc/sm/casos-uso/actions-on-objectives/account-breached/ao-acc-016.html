<!--
title: AO-ACC-016 [MEDIA] [ESPUBLICO] [AD-DS] Peticiones sospechosas al DC
description: 
published: true
date: 2024-01-24T09:19:11.957Z
tags: 
editor: ckeditor
dateCreated: 2024-01-22T12:02:09.728Z
-->

<h1 style="text-align:center;">AO-ACC-016 [MEDIA] [ESPUBLICO] [AD-DS] Peticiones sospechosas al DC</h1>
<h2>Descripción</h2>
<p style="text-align:justify;">Este caso de uso identifican distintas peticiones sobre varios objetos, entorno a 50 en menos de 5 min, al DC. Estas peticiones son generadas por ejemplo cuando lanzas el comando de Get-Object en powershell, un número anormal de estas peticiones entre otras cosas podría indicar del uso de herramientas como Bloodhound.</p>
<ul>
  <li><strong>Nombre</strong>: AO-ACC-016 [MEDIA] [ESPUBLICO] [AD-DS] Peticiones sospechosas al DC</li>
  <li><strong>Criticidad</strong>: Media</li>
  <li><strong>Tiempo de Atención</strong>: 60 minutos</li>
  <li><strong>Tecnologías utilizadas</strong>: Active Directory</li>
</ul>
<h2>MITRE</h2>
<ul>
  <li>TA0007 - Discovery.</li>
  <li>T1069 - Permission Groups Discovery.</li>
  <li>T1033 - System Owner/User Discovery.</li>
</ul>
<h2>What to do</h2>
<p style="text-align:justify;">Una vez identificado el usuario que realiza las peticiones (este se puede ver en el campo username de las peticiones) habria que identificar desde que maquina esta haciendo estas peticiones, aparece en el campo source workstation.&nbsp;</p>
<p style="text-align:justify;">Con esto identificado debemos ir al EDR para comprobar la ejecucion de alguna herramienta entorno al momento del inicio de las peticiones. Si comprobamos alguna herramienta potencialmente maliciosa como bloodhound y no ha sido notificado como pruebas se deberá bloquear el equipo y al usuario realizando las peticiones asi como pedir justificacion de la actividad.</p>
<p style="text-align:justify;">Si no vemos ningun tipo de herramienta estas peticiones podrian verse producidas por algun tipo de script/comando el cual se podria ver tambien en el EDR entorno al tiempo de las peticiones, esto podria darse el caso de algun personal de sistemas o derivados que tengan script para realizar tareas concretas. En estos casos revisar hacia que objetos esta realizando las peticiones podria sernos de utilidad (esto se puede ver en el payload o posteriormente si se ha sacado un campo con esta propiedad). en este caso estariamos ante un FP y si salta mas veces se podria valorar la opcion de incluir al usuario en un RS de exclusion.</p>
<h2>Notas de cierre</h2>
<p>Puntos mínimos que debe de tener un cierre</p>
<ul>
  <li>Usuario realizando peticiones</li>
  <li>Máquina desde la cual se hacen estas peticiones</li>
  <li>Herramienta/Script/Comando ejecutado que este realizando las peticiones</li>
  <li>Objetos a los que hace las peticiones en caso de ser necesario</li>
  <li>Resumen del análisis</li>
</ul>
<h2>Matriz de escalado</h2>
<p style="text-align:justify;">Aunque la matriz de escalado debería ser la misma para todos los casos de uso, puede haber casos que por falta de capacidades, por dependencias de otros servicio o incluso por que así se acuerde para un caso concreto, se debe definir la matriz de escalado.</p>
<p>En horario laboral: Atiende N1 y escala a N2</p>
<p>Fuera del horario Atiende N0 y escala a Guardia</p>
<h2>Reglas de caso de uso</h2>
<figure class="image image_resized" style="width:94.47%;"><img src="https://lh7-eu.googleusercontent.com/fqwLh60pVIbzm0vbcy_2tzVmcfWOvd_wYNO6PucDkJ5XxLA1JyHS1ySpU_EYNNgM8yVZDqDYidvbE4OXV4tSa6Kv2_sgvl9bm-283zHOzrckCJmB6JFs72MEDt7W1JkRSlHYGesTFUTf"></figure>
<h2>Campos Necesarios</h2>
<p>Los campos mínimos que deben seleccionarse para llevar a cabo la investigación:</p>
<ul>
  <li>Log source time (hora real de las peticiones)</li>
  <li>Username</li>
  <li>Source workstation (máquina origen de donde se hacen las peticiones, que no es la misma que la IP, ya que esta seria del DC)</li>
  <li>Username</li>
  <li>Object-id en caso de necesitarlo</li>
</ul>
<h2>Cierre por defecto</h2>
<p>Nota de cierre que se debería de rellenar a la hora de cerrar una alerta:</p>
<p><strong>Falso positivo 1:</strong></p>
<ul>
  <li>Se ha detectado que el usuario [<strong>Username</strong>]&nbsp; se ha logueado desde una ubicación fuera de España, tras una investigación de la IP [<strong>Source IP</strong>] y del usuario se determina que ha sido un fallo en la geolocalización de Qradar.</li>
</ul>
<p><strong>Falso positivo 2:</strong></p>
<ul>
  <li>Se ha detectado que el usuario [<strong>Username</strong>]&nbsp; se ha logueado desde una ubicación fuera de España, tras una investigación de la IP [<strong>Source IP</strong>] y del usuario se determina que es una conexión verídica y que el usuario está autorizado para ello.</li>
</ul>
<p><strong>Falso positivo con ajuste:</strong></p>
<ul>
  <li>Se ha detectado que el usuario [<strong>Username</strong>]&nbsp; se ha logueado desde una ubicación fuera de España, tras una investigación de la IP [<strong>Source IP</strong>] y del usuario se determina que ha sido un fallo en la geolocalización, sin embargo se localiza un&nbsp; fallo en la regla en la que [<strong>Descripción del ajuste necesario</strong>], por lo cual se abre ticket en “<a href="https://soporte.iubaris.com/"><u>https://soporte.iubaris.com/</u></a>” (RT) con número [<strong>Nº de ticket abierto</strong>].</li>
</ul>
<p><strong>Positivo:</strong></p>
<ul>
  <li>Se ha detectado que el usuario [<strong>Username</strong>]&nbsp; se ha logueado desde una ubicación fuera de España, tras una investigación de la IP [<strong>Source IP</strong>] y del usuario se determina que ha sido un fallo en la geolocalización, determinando que la cuenta del usuario ha sido comprometida&nbsp; [<strong>Análisis del robo de credenciales</strong>].</li>
</ul>
