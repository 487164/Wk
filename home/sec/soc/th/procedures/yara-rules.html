<!--
title: YARA Rules
description: Procedimiento para crear reglas YARA
published: true
date: 2024-03-11T11:22:43.909Z
tags: soc, procedure, th
editor: ckeditor
dateCreated: 2024-03-06T12:09:34.199Z
-->

<h1 style="text-align:center;">YARA Rules</h1>
<p style="text-align:justify;"><strong>YARA </strong>es una poderosa herramienta para detectar patrones y un formato de reglas que se utiliza para identificar y clasificar archivos según patrones, características o contenido específicos.</p>
<p style="text-align:justify;">Las <strong>reglas YARA </strong>generalmente se escriben en una sintaxis de reglas que define las condiciones y patrones que deben coincidir dentro de los archivos. Estas reglas pueden incluir varios elementos, como cadenas, expresiones regulares y operadores lógicos booleanos. &nbsp;Un ejemplo de regla YARA es el siguiente:</p>
<p>&nbsp;</p>
<pre><code class="language-plaintext">rule example_rule {

   meta:
       author = "Author Name"
       version = "1.0"
       description = "This is a example of YARA rule"
       hash = ""

   strings:  
       $string1 = "test"
       $string2 = "decrypt"
       $string3 = "Tor browser"

   condition:  
       all of them
} </code></pre>
<p>Cuenta con una extensa documentación oficial en su <a href="https://yara.readthedocs.io/en/latest/index.html">pagina</a>.</p>
<p>&nbsp;</p>
<h2>Repositorio esPublico</h2>
<p style="text-align:justify;">Actualmente se esta empezando a desarrollar reglas Yara, en concreto se han desarrollado reglas para diferentes variantes de Ransomware.</p>
<p style="text-align:justify;">Estas reglas se están almacenando en el repositorio de Threat-hunting:</p>
<pre><code class="language-plaintext"> ssh://git@YOUR_HOST/Threat-hunting/yara-rules/rules</code></pre>
<p style="text-align:justify;">Para desarrollar reglas YARA de Ransomware, se cuenta con una <i>template </i>que se puede utilizar para crear nuevas:</p>
<pre><code class="language-plaintext">ssh://git@YOUR_HOST/Threat-hunting/yara-rules/templates/Ransomware.yar</code></pre>
<p style="text-align:justify;">Las reglas que se creen se tendrán que subir al repositorio, trabajando con el repositorio tal como se indica en la <a href="https://wiki.security.espublico.com/es/home/sec/sto/platforms/git/descarga-directorios-concretos">guia</a>.</p>
<p>&nbsp;</p>
<h2>MISP RNS</h2>
<p style="text-align:justify;">Como se explica en el procedimiento de <a href="https://wiki.security.espublico.com/es/home/sec/soc/ti/procedures/misp-events">MISP Events</a>, la RNS otorgará 3 puntos a aquellos eventos que contengan reglas YARA. Por lo tanto, cuando se cree una regla YARA se puede aprovechar también para crear un evento en la MISP y compartirla con la RNS.</p>
<p style="text-align:justify;">&nbsp;</p>
<h2 style="text-align:justify;">Análisis de binarios &amp; Tools</h2>
<p style="text-align:justify;">Para poder crear reglas YARA que funcionen, primero debe analizarse el comportamiento de la amenaza que se quiere detectar.&nbsp;</p>
<p style="text-align:justify;">Los binarios a analizar pueden sacarse de diferentes correos de phishing que hayan entrado en la <a href="https://security.microsoft.com/quarantine">Cuarentena</a> de <strong>Office365</strong>, de un incidente real de seguridad o de diversas plataformas que almacenan malware, como puede ser <a href="https://bazaar.abuse.ch/browse/">Malware Bazaar</a>. De esta forma, pueden crearse detecciones de nuevas cepas de malware que estén usando actualmente las diferentes APT.</p>
<p style="text-align:justify;">Una vez descargado el binario, puede analizarse mediante diversas herramientas, como:</p>
<ul>
  <li style="text-align:justify;"><a href="https://any.run/">AnyRun</a>: una sandbox cloud (<i>de la cual contamos con licencia</i>) donde explotar el malware y comprobar su comportamiento.</li>
  <li style="text-align:justify;"><a href="https://www.joesandbox.com">JoeSandbox</a>: otra sandbox cloud más.</li>
  <li style="text-align:justify;"><a href="https://cuckoo.readthedocs.io/en/latest/introduction/what/">CuckooSandbox</a>: una sandbox on premise.</li>
  <li style="text-align:justify;">Strings: Tanto en Windows como en Linux, esta utilidad permite extraer cadenas de texto de un binario.</li>
  <li style="text-align:justify;"><a href="https://github.com/mandiant/capa">Capa</a>: Una herramienta para Linux con la que detectar diferentes capacidades del binario analizado.</li>
  <li style="text-align:justify;"><a href="https://ghidra-sre.org/">Ghidra</a>: herramienta de ingeniería inversa desarrollada por la NSA (<i>National Security Agency</i>).</li>
</ul>
<p>&nbsp;</p>
<h2 style="text-align:justify;">Comprobación de la eficacia de la regla</h2>
<p style="text-align:justify;">Cuando creamos una regla, hay diversas maneras de poder comprobar si funciona.</p>
<p style="text-align:justify;">La primera será pasarla directamente en el directorio en el que se encuentre el vinario que quería detectarse.</p>
<p style="text-align:center;"><i><strong><u>In progress..</u></strong></i></p>
