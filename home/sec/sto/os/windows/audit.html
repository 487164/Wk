<!--
title: Directivas de Auditoría
description: 
published: true
date: 2024-01-30T13:22:29.649Z
tags: 
editor: ckeditor
dateCreated: 2024-01-25T08:39:45.060Z
-->

<h1 style="text-align:center;">Directivas de Auditoría</h1>
<p>&nbsp;</p>
<h2>ENS Nivel ALTO</h2>
<p>Esta guía de seguridad está basada en:<br><a href="https://www.ccn-cert.cni.es/es/guias-de-acceso-publico-ccn-stic/7104-ccn-stic-570a23-perfilado-de-seguridad-para-windows-server-controlador-de-dominio-o-servidor-miembro/file.html">CCN-STIC-570A23 Perfilado de seguridad para Windows Server (controlador de dominio o servidor miembro)</a> Jul 2023<br>&nbsp;</p>
<p>Adicionalmente se habilitará el registro de información detallada del procesamiento de comandos y scripts de PowerShell.</p>
<p><a href="https://www.stigviewer.com/stig/windows_10/2017-02-21/finding/V-68819">PowerShell script block logging must be enabled. (stigviewer.com)</a></p>
<p><a href="https://admx.help/?Category=Windows_10_2016&amp;Policy=Microsoft.Policies.PowerShell::EnableScriptBlockLogging">Turn on PowerShell Script Block Logging (admx.help)</a><br>&nbsp;</p>
<h2>Configuración como GPO</h2>
<p>Crear la política ENS Alto Auditoria, editarla y hacer click con el botón derecho en Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings e importar ens_alto_auditoria.inf</p>
<figure class="image"><img src="/sec/sto/os-files/windows/audit/import.jpg"></figure>
<p>ens_alto_auditoria.inf</p>
<pre><code class="language-plaintext">[Unicode]
Unicode=yes
[Version]
signature="$CHICAGO$"
Revision=1
[Event Audit]
AuditSystemEvents=1
AuditLogonEvents=3
AuditObjectAccess=3
AuditPrivilegeUse=3
AuditPolicyChange=3
AuditAccountManage=3
AuditProcessTracking=0
AuditDSAccess=3
AuditAccountLogon=3</code></pre>
<p>Comprobar que la configuración de Audit Policy se ha importado correctamente.</p>
<figure class="image"><img src="/sec/sto/os-files/windows/audit/check.jpg"></figure>
<p>Ir a Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell &gt; Turn on PowerShell Script Block Logging y cambiarlo a Enabled</p>
<figure class="image"><img src="/sec/sto/os-files/windows/audit/scriptblock.jpg"></figure>
<p>&nbsp;</p>
<h2>Configuración en servidor independiente</h2>
<p>Ejecutar en PowerShell con permisos de administrador:</p>
<pre><code class="language-plaintext">#Establecer Audit Policy
auditpol /set /category:"Account Logon" /success:enable /failure:enable
auditpol /set /category:"Account Management" /success:enable /failure:enable
auditpol /set /category:"DS Access" /success:enable /failure:enable
auditpol /set /category:"Logon/Logoff" /success:enable /failure:enable
auditpol /set /category:"Object Access" /success:enable /failure:enable
auditpol /set /category:"Policy Change" /success:enable /failure:enable
auditpol /set /category:"Privilege Use" /success:enable /failure:enable
auditpol /set /category:"Detailed Tracking" /success:disable /failure:disable
auditpol /set /category:"System" /success:enable /failure:disable

# Auditar PowerShell
New-Item -Path "HKLM:\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Force
Set-ItemProperty -Path "HKLM:\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -Value 1 -Force
</code></pre>
<p>&nbsp;</p>
