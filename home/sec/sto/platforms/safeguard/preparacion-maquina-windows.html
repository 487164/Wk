<!--
title: Preparación de máquina windows
description: 
published: true
date: 2024-02-21T11:47:09.358Z
tags: 
editor: ckeditor
dateCreated: 2024-01-25T12:41:15.438Z
-->

<h1 style="text-align:center;">Preparación de máquina windows</h1>
<p><a href="https://support.oneidentity.com/es-es/technical-documents/one-identity-safeguard-for-privileged-passwords/7.0.4%20lts/administration-guide/125#TOPIC-2061917">https://support.oneidentity.com/es-es/technical-documents/one-identity-safeguard-for-privileged-passwords/7.0.4%20lts/administration-guide/125#TOPIC-2061917</a></p>
<p><a href="https://support.oneidentity.com/es-es/technical-documents/one-identity-safeguard-for-privileged-passwords/7.0.4%20lts/administration-guide/125#TOPIC-2061920">https://support.oneidentity.com/es-es/technical-documents/one-identity-safeguard-for-privileged-passwords/7.0.4%20lts/administration-guide/125#TOPIC-2061920</a></p>
<p><a href="https://support.oneidentity.com/kb/4314156/how-to-configure-windows-assets-in-safeguard">https://support.oneidentity.com/kb/4314156/how-to-configure-windows-assets-in-safeguard</a></p>
<p><a href="https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account">https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account</a></p>
<p>&nbsp;</p>
<p>SPP necesista una cuenta de servicio con permisos para rotar las contraseñas.</p>
<p>En los servidores windows independientes o miembros de dominio será la cuenta "aCdCmN570", que su vez será la cuenta con la que los usuarios incien sesión por RDP.</p>
<p>Hay que crear la cuenta sin caducidad de contraseña.</p>
<p>Añadirla al grupo de administradores locales.</p>
<p>Permitir en el Firewall de Windows</p>
<ul>
  <li>Windows Management Instrumentation (DCOM-In)</li>
  <li>Windows Management Instrumentation (WMI-In)</li>
  <li>NetLogon Service (NP-In)</li>
  <li>Remote Scheduled Tasks Management (RPC)</li>
</ul>
<p>En Local Security Policy&gt;Local Policies &gt; Security Options.</p>
<p>Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"</p>
<p>Reiniciar windows para que aplique este último paso.</p>
<p>&nbsp;</p>
<p>En caso de que el equipo tenga interfaz de svcs y mgmt &nbsp;comprobar que están correctamente configuradas.</p>
<p>La interfaz de mgmt sin Default Gateway y una ruta al menos hacia las VLAN de mgmt de PAM utilizando como next hoop el que habría sido el Default Gateway de la interfaz de mgmt.</p>
<p>Por ejemplo:</p>
<ul>
  <li>int svcs 192.168.212.100/24 GW 192.168.212.254</li>
  <li>int mgmt 192.168.213.100/24 sin GW</li>
</ul>
<p>Se ejecutaría para añadir las redes de VLAN de PAM</p>
<ul>
  <li>route add -p 192.168.44.184 mask 255.255.255.248 192.168.213.254</li>
  <li>route add -p 192.168.147.8 mask 255.255.255.248 192.168.213.254</li>
  <li>route add -p 192.168.217.232 mask 255.255.255.248 192.168.213.254</li>
</ul>
<pre><code class="language-plaintext">&gt;ipconfig
Ethernet adapter Ethernet:
   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::42c7:7ccf:c1f3:143b%3
   IPv4 Address. . . . . . . . . . . : 192.168.212.101
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.212.254

Ethernet adapter Ethernet 2:
   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::7af7:18a7:b76c:3da0%11
   IPv4 Address. . . . . . . . . . . : 192.168.213.101
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . :
   
&gt;route print
[...]
IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0  192.168.212.254  192.168.212.101    271
        127.0.0.0        255.0.0.0         On-link         127.0.0.1    331
        127.0.0.1  255.255.255.255         On-link         127.0.0.1    331
[...]
===========================================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
          0.0.0.0          0.0.0.0  192.168.212.254  Default
   192.168.44.184  255.255.255.248  192.168.213.254       1
    192.168.147.8  255.255.255.248  192.168.213.254       1
  192.168.217.232  255.255.255.248  192.168.213.254       1
===========================================================================

IPv6 Route Table
[...]

</code></pre>
<p>&nbsp;</p>
<p>En los Domain Controller no se pueden usar cuentas locales, además de los pasos anteriores.</p>
<p>La cuenta aCdCmN570 se debe añadir al grupo de administradores de dominio ya que no existen los administradores locales.</p>
<p>Se debe crear la cuenta aCdCmN570srv y <mark class="marker-yellow">se le deben delegar los permisos manualmente </mark>(esta delegación y el reinicio es lo único que no realiza el script)</p>
<ul>
  <li>Reset Password</li>
  <li>Read and write account restrictions</li>
  <li>Read lockoutTime</li>
  <li>Write lockOutTime</li>
</ul>
<p>Paso a paso detallado en: <a href="https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account">https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account</a></p>
<p>Esta cuenta de servicio se utilizará para rotar las contraseñas de las cuentas de dominio.</p>
<p>&nbsp;</p>
<pre><code class="language-plaintext">$name = "aCdCmN570"
$pass =  "?????????????" | ConvertTo-SecureString -AsPlainText -Force
$IsDomainController = (Get-WmiObject Win32_ComputerSystem).DomainRole -eq 5

#Si es un DC se crea la cuenta como miembro del grupo de Administradores de dominio y la cuenta de servicio con miembro de Usuarios de Acceso Remoto
#Si no se crea como administrador local
if ($IsDomainController) {
    Import-Module ActiveDirectory
    $path = (Get-ADDomain).UsersContainer
    $namesrv = "aCdCmN570srv"
    $ou = "CN=AdminSDHolder,CN=System,"+(Get-ADDomain).DistinguishedName
    $user = (Get-ADDomain).NetBIOSName+"\"+$namesrv

    New-ADUser -SamAccountName $name -Name $name -AccountPassword $pass -Path $path -PasswordNeverExpires $true -Enabled $true
    Add-ADGroupMember -Identity "S-1-5-32-544" -Members $name
    New-ADUser -SamAccountName $namesrv -Name $namesrv -AccountPassword $pass -Path $path -PasswordNeverExpires $true -Enabled $true
    Add-ADGroupMember -Identity "S-1-5-32-555" -Members $namesrv
    #Para modificar cuentas protegidas es necesario dar permisos y esperar 30 minutos a la ejecución de SDprop
    dsacls ${ou} /G ${user}:CA;"Reset Password"
    dsacls ${ou} /G ${user}:WP;"Account Restrictions" 
    dsacls ${ou} /G ${user}:WP;"LockoutTime"
} else {
    New-LocalUser -Name $name -Password $pass -PasswordNeverExpires
    Add-LocalGroupMember -SID "S-1-5-32-544" -Member $name
}

#Permitir en el firewall DCOM-In, WMI-In, NP-In y RPC
Enable-NetFirewallRule -Name "WMI-RPCSS-In-TCP", "WMI-WINMGMT-In-TCP", "Netlogon-NamedPipe-In", "RemoteTask-In-TCP"

# Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"
Set-ItemProperty -Path REGISTRY::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System -Name EnableLUA -Value 0</code></pre>
<p>&nbsp;</p>
<h2>&nbsp;</h2>
<p>&nbsp;</p>
