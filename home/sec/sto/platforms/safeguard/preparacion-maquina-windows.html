<!--
title: Preparación de máquina windows
description: 
published: true
date: 2024-02-21T10:41:13.848Z
tags: 
editor: ckeditor
dateCreated: 2024-01-25T12:41:15.438Z
-->

<h1 style="text-align:center;">Preparación de máquina windows</h1>
<p>&nbsp;</p>
<p>PAM necesista una cuenta de servicio con permisos para rotar las contraseñas.</p>
<p>En los servidores windows independientes o miembros de dominio será la cuenta "aCdCmN570", que su vez será la cuenta con la que los usuarios incien sesión por RDP.</p>
<p>Hay que crear la cuenta sin caducidad de contraseña.</p>
<p>Añadirla al grupo de administradores locales.</p>
<p>Permitir en el Firewall de Windows</p>
<ul>
  <li>Windows Management Instrumentation (DCOM-In)</li>
  <li>Windows Management Instrumentation (WMI-In)</li>
  <li>NetLogon Service (NP-In)</li>
  <li>Remote Scheduled Tasks Management (RPC)</li>
</ul>
<p>En Local Security Policy&gt;Local Policies &gt; Security Options.</p>
<p>Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"</p>
<p>Reiniciar windows para que aplique este último paso.</p>
<p>&nbsp;</p>
<p>En los Domain Controller no se pueden usar cuentas locales.</p>
<p>Se creará la cuenta aCdCmN570srv y <mark class="marker-yellow">se le deben delegar los permisos manualmente </mark>(esta delegación y el reinicio es lo único que no realiza el script)</p>
<ul>
  <li>Reset Password</li>
  <li>Read and write account restrictions</li>
  <li>Read lockoutTime</li>
  <li>Write lockOutTime</li>
</ul>
<p>Paso a paso detallado en: <a href="https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account">https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account</a></p>
<p>Esta cuenta de servicio se utilizará para crear un asset de Active Directory en PAM, donde se añadirá también la cuenta aCdCmN570 de dominio que también habrá creado el script.</p>
<p>Al crear los assets de los DC no se les asignará una cuenta de servicio, sino que se les añadirá como Account Dependency ambas cuentas, la que está marcada como de servicio la utilizará para rotar cuentas de dominio.</p>
<p><mark class="marker-yellow">¿Es necesario entonces el asignar una request a los dc o se puede hacer normal asignando cuentas y máquinas a la normal?</mark></p>
<p>Reiniciar windows.</p>
<pre><code class="language-plaintext">$name = "aCdCmN570"
$pass =  "?????????????" | ConvertTo-SecureString -AsPlainText -Force
$IsDomainController = (Get-WmiObject Win32_ComputerSystem).DomainRole -eq 5

#Si es un DC se crea la cuenta como miembro del grupo de Administradores de dominio y la cuenta de servicio con miembro de Usuarios de Acceso Remoto
#Si no se crea como administrador local
if ($IsDomainController) {
    Import-Module ActiveDirectory
    $path = (Get-ADDomain).UsersContainer
    $namesrv = "aCdCmN570srv"
    $ou = "CN=AdminSDHolder,CN=System,"+(Get-ADDomain).DistinguishedName
    $user = (Get-ADDomain).NetBIOSName+"\"+$namesrv

    New-ADUser -SamAccountName $name -Name $name -AccountPassword $pass -Path $path -PasswordNeverExpires $true -Enabled $true
    Add-ADGroupMember -Identity "S-1-5-32-544" -Members $name
    New-ADUser -SamAccountName $namesrv -Name $namesrv -AccountPassword $pass -Path $path -PasswordNeverExpires $true -Enabled $true
    Add-ADGroupMember -Identity "S-1-5-32-555" -Members $namesrv
    #Para modificar cuentas protegidas es necesario dar permisos y esperar 30 minutos a la ejecución de SDprop
    dsacls ${ou} /G ${user}:CA;"Reset Password"
    dsacls ${ou} /G ${user}:WP;"Account Restrictions" 
    dsacls ${ou} /G ${user}:WP;"LockoutTime"
} else {
    New-LocalUser -Name $name -Password $pass -PasswordNeverExpires
    Add-LocalGroupMember -SID "S-1-5-32-544" -Member $name
}

#Permitir en el firewall DCOM-In, WMI-In, NP-In y RPC
Enable-NetFirewallRule -Name "WMI-RPCSS-In-TCP", "WMI-WINMGMT-In-TCP", "Netlogon-NamedPipe-In", "RemoteTask-In-TCP"

# Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"
Set-ItemProperty -Path REGISTRY::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System -Name EnableLUA -Value 0</code></pre>
<p><a href="https://support.oneidentity.com/kb/4314156/how-to-configure-windows-assets-in-safeguard">https://support.oneidentity.com/kb/4314156/how-to-configure-windows-assets-in-safeguard</a></p>
<h2><strong>Configuración adicional en servidor controlador de dominio</strong></h2>
<p><a href="https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account">https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account</a></p>
<p>Para la cuenta de servicio "aCdCmN570srv" se deben delegar los permisos (ojo, si por cualquier motivo fuera necesario convertirla en miembro de Domain Admins, Admistrator o Enterprise Admin groups perdería los permisos en 60 minutos y habría que crear las dsacls que indica al documentación)</p>
<ul>
  <li>Reset Password</li>
  <li>Read and write account restrictions</li>
  <li>Read lockoutTime</li>
  <li>Write lockOutTime</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
