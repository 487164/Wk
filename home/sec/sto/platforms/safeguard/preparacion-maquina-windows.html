<!--
title: Preparación de máquina windows
description: 
published: true
date: 2024-02-09T10:39:13.469Z
tags: 
editor: ckeditor
dateCreated: 2024-01-25T12:41:15.438Z
-->

<h1 style="text-align:center;">Preparación de máquina windows</h1>
<p style="text-align:center;"><mark class="marker-yellow">Ojo: Documento en desarrollo → ask ralfaro</mark></p>
<p style="text-align:center;">&nbsp;</p>
<p><a href="https://support.oneidentity.com/kb/4314156/how-to-configure-windows-assets-in-safeguard">https://support.oneidentity.com/kb/4314156/how-to-configure-windows-assets-in-safeguard</a></p>
<h2><strong>Configuración en servidor independiente</strong></h2>
<p><a href="https://support.oneidentity.com/es-es/technical-documents/one-identity-safeguard-for-privileged-passwords/7.0.4%20lts/administration-guide/125#TOPIC-2061917">https://support.oneidentity.com/es-es/technical-documents/one-identity-safeguard-for-privileged-passwords/7.0.4%20lts/administration-guide/125#TOPIC-2061917</a></p>
<p>Crear la cuenta de administrador local "aCdCmN570", sin caducidad de contraseña.</p>
<p>Permitir en el Firewall de Windows</p>
<ul>
  <li>Windows Management Instrumentation (DCOM-In)</li>
  <li>Windows Management Instrumentation (WMI-In)</li>
  <li>NetLogon Service (NP-In)</li>
  <li>Remote Scheduled Tasks Management (RPC)</li>
</ul>
<p>En Local Security Policy&gt;Local Policies &gt; Security Options.</p>
<p>Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"</p>
<p>Reiniciar windows.</p>
<p><a href="https://drive.google.com/file/d/1iVd7ltzzvxMhPWuRH7ZGXWnknUmorL7X/view?usp=drive_link">local.ps1</a></p>
<pre><code class="language-plaintext">#Crear la cuenta de administrador local "aCdCmN570", sin caducidad de contraseña.
$Password = Read-Host -AsSecureString "Introduce una contraseña segura para la cuenta de usuario 'aCdCmN570'"
New-LocalUser -Name "aCdCmN570" -Password $Password -AccountNeverExpires
Add-LocalGroupMember -SID "S-1-5-32-544" -Member "aCdCmN570"

#Permitir en el firewall DCOM-In, WMI-In, NP-In y RPC
Enable-NetFirewallRule -Name "WMI-RPCSS-In-TCP", "WMI-WINMGMT-In-TCP", "Netlogon-NamedPipe-In", "RemoteTask-In-TCP"

# Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"
Set-ItemProperty -Path REGISTRY::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System -Name EnableLUA -Value 0</code></pre>
<p>&nbsp;</p>
<h2><strong>Configuración en servidor miembro de dominio</strong></h2>
<p><a href="https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account">https://support.oneidentity.com/es-es/one-identity-safeguard-for-privileged-passwords/kb/4263587/how-to-delegate-permissions-in-active-directory-for-a-safeguard-service-account</a></p>
<p>Crear la aCdCmN570</p>
<p><mark class="marker-yellow">OJO No le he dado permiso para acceso remoto!</mark></p>
<p><mark class="marker-yellow">Crear el asset de active directory poniendo el DC por IP ( no puede resolver) y sin SSL o falla</mark></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre><code class="language-plaintext"># Importa el módulo ActiveDirectory
Import-Module ActiveDirectory

$name = "aCdCmN570"
$path = (Get-ADDomain).UsersContainer

# Crear la cuenta "aCdCmN570", sin caducidad de contraseña.
$pass = Read-Host -AsSecureString "Introduce una contraseña segura para la cuenta de usuario 'aCdCmN570'"
New-ADUser -SamAccountName $name -Name $name -AccountPassword $pass -Path $path -PasswordNeverExpires $true -Enabled $true

# Asignar los permisos para cambiar contraseñas, bloquear y desbloqeuar cuentas.
# Dará error si el sistema no está en inglés. Configurar a mano
$obj = "CN=AdminSDHolder,CN=System,"+(Get-ADDomain).DistinguishedName
$user = (Get-ADDomain).Name+"\"+$name
dsacls $obj /G $user":CA";"Reset Password" 
dsacls $obj /G $user":WP";"Account Restrictions" 
dsacls $obj /G $user":WP";"LockoutTime"

#Permitir en el firewall DCOM-In, WMI-In, NP-In y RPC
Enable-NetFirewallRule -Name "WMI-RPCSS-In-TCP", "WMI-WINMGMT-In-TCP", "Netlogon-NamedPipe-In", "RemoteTask-In-TCP"

# Cambiar a Disable: "User Account Control: Run all administrators in Admin Approval Mode"
Set-ItemProperty -Path REGISTRY::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System -Name EnableLUA -Value 0


# Añadir al usuario al grupo de Desktop Users si va a tener que conectarse por RDP o a Administradores si necesita configurar
$respuesta1 = Read-Host "¿Además de para que safeguard se concte al AD, esta cuenta se va a usar para conectarse a las máquinas por RDP? (S/N)"
if ($respuesta1 -eq "S") {
    $respuesta2 = Read-Host "¿Necesita permisos de administrador?"
    # Se añade a Domain Admins
    if ($respuesta2 -eq "S"){
        $groupSID = "S-1-5-32-544"
    }
    # Se añade a Remote Desktop Users
    else {
        $groupSID = "S-1-5-32-555"
    }
    Add-ADGroupMember $groupSID -Members $name
}</code></pre>
